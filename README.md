# Loft

A lightweight, client-only Nix binary cache uploader for S3-compatible storage like Garage or MinIO.

## Features

*   Direct S3 Upload: Uploads NARs directly to your S3 bucket.
*   Nix Store Watcher: Watches the /nix/store for new paths and automatically uploads them.
*   Multi-threaded Uploads: Uploads multiple NARs in parallel to speed up the process.
*   Closure Deduplication: Before uploading, it checks which paths in a closure already exist in the cache to avoid redundant work.
*   **Initial Scan on Startup**: Optionally scans existing Nix store paths on startup and uploads them if they are missing from the cache. This scan runs only once.
*   **Automatic Retries for Failed Uploads**: Automatically retries failed uploads (e.g., due to transient network issues) a few times before giving up.
*   **Nix Store Path Signing**: Supports signing uploaded Nix store paths with a provided Nix signing key, ensuring authenticity and integrity.

## Configuration

Loft can be configured via a `loft.toml` file. In the development environment (using `nix develop` or `direnv`), this file is automatically generated based on environment variables. For production deployments, you will need to create this file manually.

Here's an example `loft.toml` with default values:

```toml
[s3]
bucket = "your-nix-cache-bucket"
region = "us-east-1"
endpoint = "http://localhost:9000"
# Optional: S3 access key. If not provided, will attempt to read from AWS_ACCESS_KEY_ID environment variable.
access_key = "your-access-key"
# Optional: S3 secret key. If not provided, will attempt to read from AWS_SECRET_ACCESS_KEY environment variable.
secret_key = "your-secret-key"

[loft]
# Optional: Number of concurrent uploads
upload_threads = 8

# Optional: Set to true to perform an initial scan of the Nix store on startup.
# This scan runs only once. Defaults to false.
scan_on_startup = true

# Optional: Path to your Nix signing key file (e.g., /etc/nix/signing-key.sec)
# If provided, uploaded paths will be signed.
signing_key_path = "/path/to/your/nix-signing-key.sec"

# Optional: Name of your Nix signing key (e.g., "cache.example.org-1")
# Required if signing_key_path is provided.
signing_key_name = "your-cache-key-name"
```

### Development Environment (with rclone)

The `flake.nix` is configured to provide `rclone` in the development shell. It will automatically generate an `rclone.conf` file using your `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` environment variables (sourced from your `.env` file if you use `direnv`).

To use `rclone`:
1. Ensure your `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` are set in your environment (e.g., in a `.env` file sourced by `direnv`).
2. Enter the development shell: `nix develop` (or `direnv allow` if you have `direnv` set up).
3. `rclone` will be available and configured to use your S3 credentials. You can verify with `rclone config show s3:`.

Note: The `region` for the `rclone` S3 remote is currently hardcoded to `us-east-1` in `flake.nix`.

### Sample .env file

Create a `.env` file in the project root with the following variables. These will be used to automatically configure `loft.toml` and `rclone` in the development shell.

```dotenv
AWS_ACCESS_KEY_ID="your_aws_access_key_id"
AWS_SECRET_ACCESS_KEY="your_aws_secret_access_key"

# Optional: For custom S3-compatible endpoints (e.g., MinIO, Garage)
S3_ENDPOINT="http://localhost:9000"

# Optional: The S3 bucket name for rclone configuration
S3_BUCKET="your-nix-cache-bucket"

# Optional: Number of concurrent uploads for Loft
LOFT_UPLOAD_THREADS=8

# Optional: Set to true to perform an initial scan of the Nix store on startup for Loft
LOFT_SCAN_ON_STARTUP=true

# Optional: Path to your Nix signing key file
NIX_SIGNING_KEY_PATH="/path/to/your/nix-signing-key.sec"

# Optional: Name of your Nix signing key
NIX_SIGNING_KEY_NAME="your-cache-key-name"
```

## Usage

```bash
cargo run -- --config /path/to/your/loft.toml
```