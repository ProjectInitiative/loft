# Loft

Loft is a lightweight, client-only Nix binary cache uploader designed for S3-compatible storage like Garage or MinIO. The name "Loft" is a nod to its inspiration, [Attic](https://github.com/zhaofengli/attic), and its primary backend target, [Garage](https://garage.deuxfleurs.fr/). It sits somewhere in between—a cozy loft between the attic and the garage.

While Attic is a fantastic, feature-rich solution, it requires a server-client setup that may be more than what's needed for simpler use cases. Loft fills a specific gap: providing the convenience of a client-side helper with some of Attic’s best features (like cache checking, native Nix bindings, and watching the Nix store) without the overhead of deploying and managing a server, users, and permissions.

It's designed for scenarios where you want more than just a raw S3 bucket but don't need a full-scale cache server. Think of it as the perfect tool for:

*   **CI/CD pipelines**: Quickly and efficiently pushing build artifacts to a cache.
*   **Single-user setups**: A simple way to manage your own binary cache.
*   **Homelabs**: An easy-to-deploy cache for your local network.

If you're looking for a straightforward, no-fuss way to manage a Nix cache on S3, Loft is for you.

## Features

*   Direct S3 Upload: Uploads NARs directly to your S3 bucket.
*   Nix Store Watcher: Watches the /nix/store for new paths and automatically uploads them.
*   Multi-threaded Uploads: Uploads multiple NARs in parallel to speed up the process.
*   Closure Deduplication: Before uploading, it checks which paths in a closure already exist in the cache to avoid redundant work.
*   **Initial Scan on Startup**: Optionally scans existing Nix store paths on startup and uploads them if they are missing from the cache. This scan runs only once.
*   **Automatic Retries for Failed Uploads**: Automatically retries failed uploads (e.g., due to transient network issues) a few times before giving up.
*   **Nix Store Path Signing**: Supports signing uploaded Nix store paths with a provided Nix signing key, ensuring authenticity and integrity.


## NixOS Integration

Loft provides a NixOS module to simplify configuration and deployment. The module can configure your system as a cache "pusher" (running the loft service) and/or a "puller" (configuring Nix to use the cache).

### 1. Add Loft to your Flake

First, add the Loft flake to the inputs of your system's flake.nix.
Nix

```nix
# flake.nix
{
  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
    # Add the loft flake
    loft.url = "github:projectinitiative/loft";
  };

  outputs = { self, nixpkgs, loft, ... }: {
    nixosConfigurations.my-machine = nixpkgs.lib.nixosSystem {
      system = "x88_64-linux";
      modules = [
        ./configuration.nix
        # Simply import the loft module. It handles the rest.
        loft.nixosModules.loft
      ];
    };
  };
}
```

### 2. Configure the Loft Service

In your configuration.nix (or a related file), you can now enable and configure the service.
Nix

```nix
# configuration.nix
{ pkgs, ... }:

{

  services.loft = {
    enable = true;
    package = pkgs.loft; # Use the package from the overlay

    # --- PULLER CONFIG ---
    # Configure this machine to pull from the cache
    puller = {
      enable = true;
      trustedPublicKeys = [ "my-cache.example.com-1:key-goes-here=" ];
    };

    # --- PUSHER (SERVICE) CONFIG ---
    # These options generate the loft.toml for the systemd service
    s3 = {
      bucket = "my-nix-cache";
      region = "us-west-2";
      endpoint = "https://s3.us-west-2.amazonaws.com";

      # It's highly recommended to use sops-nix or agenix for secrets
      accessKeyFile = /path/to/your/s3-access-key;
      secretKeyFile = /path/to/your/s3-secret-key;
    };

    # Path to the Nix signing key for the pusher
    signingKeyFile = /path/to/your/nix-private-key;
    signingKeyName = "my-cache.example.com-1";

    # Path for the local cache database
    localCachePath = "/var/lib/loft/cache.db";

    scan_on_startup = true;

    # You can also set any other option from loft.toml here, for example:
    upload_threads = 8;

    # Use extraConfig for new or unlisted options to prevent module errors
    extraConfig = {
      loft = {
        # This will be merged into the final toml
        some_new_feature_flag = true;
      };
    };
  };
}
```

## Configuration

Loft can be configured via a `loft.toml` file. In the development environment (using `nix develop` or `direnv`), this file is automatically generated based on environment variables. For production deployments, you will need to create this file manually.

Here's an example `loft.toml` with default values:

```toml
[s3]
bucket = "your-nix-cache-bucket"
region = "us-east-1"
endpoint = "http://localhost:9000"
# Optional: S3 access key. If not provided, will attempt to read from AWS_ACCESS_KEY_ID environment variable.
access_key = "your-access-key"
# Optional: S3 secret key. If not provided, will attempt to read from AWS_SECRET_ACCESS_KEY environment variable.
secret_key = "your-secret-key"

[loft]
# Optional: Number of concurrent uploads
upload_threads = 8

# Optional: Set to true to perform an initial scan of the Nix store on startup.
# This scan runs only once. Defaults to false.
scan_on_startup = true

# Optional: Path to your Nix signing key file (e.g., /etc/nix/signing-key.sec)
# If provided, uploaded paths will be signed.
signing_key_path = "/path/to/your/nix-signing-key.sec"

# Optional: Name of your Nix signing key (e.g., "cache.example.org-1")
# Required if signing_key_path is provided.
signing_key_name = "your-cache-key-name"

# Optional: List of public keys whose signed paths should be skipped for upload.
# If a path is signed by any of these keys, it will not be uploaded.
# Example: skip_signed_by_keys = ["cache.nixos.org-1", "nix-community.cachix.org-1"]
skip_signed_by_keys = []

# Optional: Set to true to use disk for large NARs instead of memory.
# Defaults to false.
use_disk_for_large_nars = true

# Optional: The threshold in MB for what is considered a large NAR.
# Defaults to 1024 (1GB).
large_nar_threshold_mb = 2048
```

### Development Environment (with rclone)

The `flake.nix` is configured to provide `rclone` in the development shell. It will automatically generate an `rclone.conf` file using your `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` environment variables (sourced from your `.env` file if you use `direnv`).

To use `rclone`:
1. Ensure your `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` are set in your environment (e.g., in a `.env` file sourced by `direnv`).
2. Enter the development shell: `nix develop` (or `direnv allow` if you have `direnv` set up).
3. `rclone` will be available and configured to use your S3 credentials. You can verify with `rclone config show s3:`.

Note: The `region` for the `rclone` S3 remote is currently hardcoded to `us-east-1` in `flake.nix`.

### Sample .env file

Create a `.env` file in the project root with the following variables. These will be used to automatically configure `loft.toml` and `rclone` in the development shell.

```dotenv
AWS_ACCESS_KEY_ID="your_aws_access_key_id"
AWS_SECRET_ACCESS_KEY="your_aws_secret_access_key"

# Optional: For custom S3-compatible endpoints (e.g., MinIO, Garage)
S3_ENDPOINT="http://localhost:9000"

# Optional: The S3 bucket name for rclone configuration
S3_BUCKET="your-nix-cache-bucket"

# Optional: Number of concurrent uploads for Loft
LOFT_UPLOAD_THREADS=8

# Optional: Set to true to perform an initial scan of the Nix store on startup for Loft
LOFT_SCAN_ON_STARTUP=true

# Optional: Path to your Nix signing key file
NIX_SIGNING_KEY_PATH="/path/to/your/nix-signing-key.sec"

# Optional: Name of your Nix signing key
NIX_SIGNING_KEY_NAME="your-cache-key-name"

# Optional: Comma-separated list of public keys whose signed paths should be skipped for upload.
# Example: LOFT_SKIP_SIGNED_BY_KEYS="cache.nixos.org-1,nix-community.cachix.org-1"
LOFT_SKIP_SIGNED_BY_KEYS=""

# Optional: Set to true to use disk for large NARs instead of memory.
LOFT_USE_DISK_FOR_LARGE_NARS=true

# Optional: The threshold in MB for what is considered a large NAR.
LOFT_LARGE_NAR_THRESHOLD_MB=2048
```

## Usage

```bash
cargo run -- --config /path/to/your/loft.toml
```
